<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.2</storyId>
    <title>"Magic Fill" AI Suggestions</title>
    <status>drafted</status>
    <generatedAt>2025-12-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-magic-fill-ai-suggestions.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As a user</asA>
    <iWant>when creating or editing a task, I want to click a "Magic Fill" button to get AI-powered suggestions for the label and priority</iWant>
    <soThat>so that I can organize tasks faster</soThat>
    <tasks>
      <task>
        <title>1. Frontend Implementation (templates/index.html &amp; custom JS):</title>
        <subtask>- Add a "Magic Fill" button to the "Add Task" and "Edit Task" modals. (AC: #1)</subtask>
        <subtask>- Implement a JavaScript function to handle the button click. (AC: #1)</subtask>
        <subtask>- The function should trigger a `POST` request to the `/api/suggest` endpoint with the task title. (AC: #1)</subtask>
        <subtask>- Implement UI logic to show a loading state on the button during the API call. (AC: #2)</subtask>
        <subtask>- On successful response, populate the 'label' and 'priority' form fields with the returned data. (AC: #3, #4)</subtask>
        <subtask>- Handle API errors gracefully (e.g., show a toast notification). (AC: #5)</subtask>
      </task>
      <task>
        <title>2. Backend API Endpoint (app.py):</title>
        <subtask>- Create a new Flask route `/api/suggest` that accepts `POST` requests. (AC: #1, #5)</subtask>
        <subtask>- In the route handler, extract the `title` from the incoming JSON request. (AC: #1)</subtask>
        <subtask>- Call the `get_ai_suggestions(title)` function from the `ai_service` module. (AC: #5)</subtask>
        <subtask>- Return the result from the `ai_service` as a JSON response. (AC: #3)</subtask>
      </task>
      <task>
        <title>3. Verification &amp; Testing:</title>
        <subtask>- **E2E Test**: Write a test using Playwright to simulate a user clicking the "Magic Fill" button and verify that the form fields are populated with mock data. (AC: #1, #2, #3, #4)</subtask>
        <subtask>- **Integration Test**: Write a test for the `/api/suggest` endpoint that mocks the `ai_service.get_ai_suggestions` function to ensure the endpoint correctly proxies the request and response. (AC: #1, #3, #5)</subtask>
        <subtask>- **Manual Test**: Manually test the full flow in a running application to confirm the frontend and backend are correctly integrated. (AC: #1, #2, #3, #4, #5)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="AC1">Given the user is in the "Add Task" or "Edit Task" modal, when they click the "Magic Fill" button, the task description is sent to the backend AI service via a `POST` request to `/api/suggest`.</ac>
    <ac id="AC2">A subtle loading indicator appears on the "Magic Fill" button until a response is received from the backend.</ac>
    <ac id="AC3">The `label` and `priority` fields in the form are populated with the suggestions returned by the AI service.</ac>
    <ac id="AC4">The user can then accept, override, or edit these suggestions before saving the task.</ac>
    <ac id="AC5">The interaction follows the "AI-Suggestion Flow" as defined in the architecture, ensuring a seamless user experience.</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/fase-3-solutioning/architecture.md</path>
        <title>Architecture</title>
        <section>Novel Pattern Designs: AI-Suggestion Flow (Magic Fill)</section>
        <snippet>This pattern's data flow includes: Trigger (Frontend button), API Request (POST /api/suggest), Request Handling (Backend calls ai_service), AI Service Logic (constructs prompt, calls Gemini), Response Handling (parses success or triggers fallback), API Response (returns JSON to frontend), Display (frontend populates fields).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Task Intelligence</title>
        <section>Detailed Design: APIs and Interfaces - POST /api/suggest</section>
        <snippet>This provides the contract for the `/api/suggest` endpoint, specifying the request body `{"title": "String"}` and the success response body `{"priority": "String", "label": "String"}`.</snippet>
      </doc>
       <doc>
        <path>docs/fase-2-planning/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>Novel UX Pattern: The "AI-Suggestion Flow"</section>
        <snippet>The primary novel pattern is the "Magic Fill" interaction. Trigger: User clicks the "Magic Fill" button. Flow: Loading indicator appears, AI service is called, Label and Priority fields are populated. The user can then immediately save or modify the suggestions.</snippet>
      </doc>
      <doc>
        <path>docs/fase-2-planning/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR7: The system can suggest a label... FR8: The system can suggest a priority... FR9: Users can review and accept AI-suggested labels and priorities. FR10: Users can override or edit AI-suggested labels and priorities before saving.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app.py</path>
        <kind>Flask Application</kind>
        <symbol>/api/suggest</symbol>
        <reason>This is the new API endpoint that will be created to handle the AI suggestion requests from the frontend.</reason>
      </artifact>
      <artifact>
        <path>ai_service.py</path>
        <kind>Python Module</kind>
        <symbol>get_ai_suggestions</symbol>
        <reason>This existing function will be called by the new API endpoint to get the AI suggestions.</reason>
      </artifact>
      <artifact>
        <path>templates/index.html</path>
        <kind>HTML Template</kind>
        <symbol>#magic-fill-button</symbol>
        <reason>The UI for triggering the AI suggestion flow will be added to this file.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="Flask" version="3.1.2" />
        <package name="Flask-SQLAlchemy" version="3.1.1" />
        <package name="google-generativeai" version="Not specified" />
      </python>
      <nodejs>
        <package name="@faker-js/faker" version="8.4.1" type="dev" />
        <package name="@playwright/test" version="1.57.0" type="dev" />
        <package name="@types/node" version="^24.10.1" type="dev" />
        <package name="autoprefixer" version="^10.4.22" type="dev" />
        <package name="postcss" version="^8.5.6" type="dev" />
        <package name="tailwindcss" version="^3.4.16" type="dev" />
      </nodejs>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API endpoint must be `POST /api/suggest`.</constraint>
    <constraint>The frontend must show a loading indicator during the API call.</constraint>
    <constraint>The AI service call must be proxied through the backend (`app.py`) and not made directly from the client.</constraint>
    <constraint>The user must always be able to override the AI suggestions before saving.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>/api/suggest</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/suggest</signature>
      <path>app.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>The test strategy follows a test pyramid approach with a mix of unit, integration, and E2E tests. Unit tests for `ai_service.py`, Integration tests for `/api/suggest`, and E2E tests for the full UI flow.</standards>
    <locations>
      <location>tests/</location>
    </locations>
    <ideas>
      <idea ac_id="AC1">E2E Test: User clicks Magic Fill and verifies an API call is made to `/api/suggest`.</idea>
      <idea ac_id="AC2">E2E Test: Verify a loading indicator is visible after clicking "Magic Fill" and hidden after the response.</idea>
      <idea ac_id="AC3">Integration Test: Mock the `ai_service` and verify the `/api/suggest` endpoint returns the mocked data.</idea>
      <idea ac_id="AC4">E2E Test: After suggestions are populated, edit the fields and save the task to ensure the overridden values are used.</idea>
      <idea ac_id="AC5">Integration Test: Mock a failure from the `ai_service` and ensure the API still returns a valid (fallback) response.</idea>
    </ideas>
  </tests>
</story-context>